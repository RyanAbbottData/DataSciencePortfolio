---
title: "R Notebook"
output: 
    html_document:
      toc: yes
      toc_float: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Run this befor every session
install.packages("nbastatR")
Sys.setenv("VROOM_CONNECTION_SIZE" = 262144)
library("nbastatR")
library("dplyr")
library("tidyverse")
library("gt")
library("webshot2")
```



## Exploratory Data Analysis

The following chunk imports the dataset that I will be using for this project. Because the creation of the dataset is memory intensive and takes several minutes to complete, I have already created and saved it as a CSV file. The code used for this process can be found in 'create_training_dataset.R'.
```{r}
library("ggplot2")


data <- read_csv("MVP_Model_Training_data.csv", show_col_types = FALSE)
```

First, the label must be converted into a numeric instead of a factor.
```{r}
data <- data %>% replace_na(list(mvp=0))
data <- mutate(data, is_mvp = case_when(mvp == 0 ~ "NO",
                                        mvp == 1 ~ "YES"))
```


# Measures of Variation and Outliers

Next, I calculated the z-scores of each feature, and created a new dataset. With this, I can compare the data to each other. 
```{r}
data_normalized <- mutate(data, pts = scale(pts), ast = scale(ast), reb = scale(reb), win_pct = scale(win_pct))
head(data_normalized)
```

To find some potential MVP candidates in the training dataset, I filtered the data to find players who have averages that are over 2 standard deviations away from the mean of the respective stats. In other words, finding instances where z > 2 or z < -2.
```{r}
pts_outliers <- arrange(filter(data_normalized, abs(pts) > 3), desc(pts))
ast_outliers <- arrange(filter(data_normalized, abs(ast) > 3), desc(ast))
reb_outliers <- arrange(filter(data_normalized, abs(reb) > 3), desc(reb))

head(pts_outliers)
head(ast_outliers)
head(reb_outliers)
```

The relative frequency of MVPs in each statistical category are:
```{r}
sum(pts_outliers$mvp) / nrow(pts_outliers)
sum(ast_outliers$mvp) / nrow(ast_outliers)
sum(reb_outliers$mvp) / nrow(reb_outliers)
```


It seems, unsurprisingly, that points are the most important factor in determining an MVP. Assists and rebounds are important, too.

Visualizations of these distributions are included below:
```{r}
ggplot(data, aes(x=is_mvp, y=win_pct, fill=is_mvp)) + geom_boxplot() + guides(color = guide_legend(title = "Is MVP")) + xlab("Is MVP") + ylab("Win Percentage") + ggtitle("Distribution of Win Percentages in Games Played, non MVPs and MVPs") + labs(fill="Is MVP")
ggsave("winpct_boxplot.png")

ggplot(data, aes(x=is_mvp, y=pts, fill=is_mvp)) + geom_boxplot() + guides(color = guide_legend(title = "Is MVP")) + xlab("Is MVP") + ylab("Points Per Game") + ggtitle("Distribution of Points Per Game Scored, non MVPs and MVPs") + labs(fill="Is MVP")

ggplot(data, aes(x=is_mvp, y=reb, fill=is_mvp)) + geom_boxplot() + guides(color = guide_legend(title = "Is MVP")) + xlab("Is MVP") + ylab("Rebounds Per Game") + ggtitle("Distribution of Rebounds Per Game Scored, non MVPs and MVPs") + labs(fill="Is MVP")

ggplot(data, aes(x=is_mvp, y=ast, fill=is_mvp)) + geom_boxplot() + guides(color = guide_legend(title = "Is MVP")) + xlab("Is MVP") + ylab("Assists Per Game") + ggtitle("Distribution of Assists Per Game Scored, non MVPs and MVPs") + labs(fill="Is MVP")


ggplot(data, aes(x=pts,y=ast,color=is_mvp,label=names)) + geom_point() +  geom_text(aes(label=ifelse(mvp==1,as.character(names),'')),hjust=0,vjust=0, size=2) + guides(color = guide_legend(title = "Is MVP")) + ggtitle("Points Per Game Scored Compared to Assists Per Game") + ylab("Assists Per Game") + xlab("Points Per Game")

                                                                                    
ggplot(data, aes(x=pts,y=reb,color=is_mvp,label=names)) + geom_point() +  geom_text(aes(label=ifelse(mvp==1,as.character(names),'')),hjust=0,vjust=0, size=2) + guides(color = guide_legend(title = "Is MVP")) + ggtitle("Points Per Game Scored Compared to Rebounds Per Game") + ylab("Rebounds Per Game") + xlab("Points Per Game")

ggplot(data_normalized, aes(x=pts + ast + reb + win_pct)) + geom_density(alpha=.2, fill="#FF6666") 



```

Now for measures of central tendency. Mean and median are included, as MVPs and MVP caliber players heavily skew the data.
```{r}
#Analyzing the dataset in various ways

#Finding the mean PPG of all players and MVPs
mean(data$pts)
mean(filter(data, mvp == 1)$pts)

#Finding the median PPG of all players and MVPs
median(data$pts)
median(filter(data, mvp==1)$pts)
```

```{r}
#Finding mean APG of all players and MVPs
mean(data$ast)
mean(filter(data, mvp == 1)$ast)

#Finding the median APG of all players and MVPs
median(data$ast)
median(filter(data, mvp==1)$ast)
```

```{r}
#Finding mean RPG of all players and MVPs
mean(data$reb)
mean(filter(data, mvp == 1)$reb)

#Finding the median RPG of all players and MVPs
median(data$reb)
median(filter(data, mvp==1)$reb)
```

```{r}
#Finding mean win percentage of all players and MVPs
mean(filter(data, mvp == 1)$win_pct)
mean(filter(data, mvp == 1)$wins)

#Finding the median win pct of all players and MVPs
median(data$pts)
median(filter(data, mvp==1)$pts)
```


Finding mean number of total games played:
```{r}
mean(filter(data, mvp == 1)$total_games)
```
In this next section, I will examine whether voter fatigue may be an important factor in MVP considerations. These are the 2 players who had multiple consecutive MVPs within the scope of the dataset, and the following 2 (or 3, in the case of Lebron James, whose first of two consecutive MVPS from 2012-2014 was not included on this version of the project):
```{r}
ga <- data %>% filter(names == 'Giannis Antetokounmpo', year == 2019 | year == 2020 | year == 2021 | year == 2022)

lbj <- data %>% filter(names == 'LeBron James', year == 2013 | year == 2014 | year == 2015 | year == 2016)

sc <- data %>% filter(names == 'Stephen Curry', year == 2015 | year == 2016 | year == 2017 | year == 2018)



table <- bind_rows(as_tibble(ga), lbj, sc) %>% gt() %>% tab_header(title = "Filler") %>% fmt_number(columns = c(pts, ast, reb, wins, total_games, win_pct, year))

table
#table %>% gtsave(filename = "test_table.png", expand = 10)
```
A common trend with each of these cases is the decline in win percentage in the years following their consecutive MVPs. 

Examining these 3 players individually, Giannis Antetokounmpo's averages hovered around the same range for all 4 years. For him, the main difference is win percentage. As for Stephen Curry, the reason might be the most obvious; the arrival of Kevin Durant in Golden State took shots away from curry. On top of that, their win percentage was worse than his MVP seasons. Lebron James recorded quite similar averages during all 4 seasons, but the only season his personal win percentage was over 80% was his MVP season in 2013. Clearly, regardless of the quantity of points, rebounds, and assists a player records, a low win percentage will exclude them from consideration in most cases.




## Applying the model to the current season

With lots of information extracted from the data from some exploratory data analysis, the model can now be applied to the 2023 season thus far.
```{r}
#Building Model
#Creating Training and Testing Data
#source("game_logs.R")
?nbastatR
current_data <- game_logs(seasons = 2023)
current_data <- mutate(current_data, isWin = case_when(outcomeGame == "W" ~ 1,
                                               outcomeGame == "L" ~ 0), isGame = 1)

wins <- aggregate(current_data$isWin, list(current_data$namePlayer), sum)
total_games <- aggregate(current_data$isGame, list(current_data$namePlayer), sum)
pts <- aggregate(current_data$pts, list(current_data$namePlayer), mean)
ast <- aggregate(current_data$ast, list(current_data$namePlayer), mean)
reb <- aggregate(current_data$treb, list(current_data$namePlayer), mean)
current_season_df <- tibble(
  names = pts$Group.1,
  pts = pts$x,
  ast = ast$x,
  reb = reb$x,
  wins = wins$x,
  total_games = total_games$x,
  win_pct = wins/total_games,
  year = 2023
)

current_season_df

current_season_df_normalized <- mutate(current_season_df, pts = scale(pts), ast = scale(ast), reb = scale(reb), win_pct = scale(win_pct))
current_season_df_normalized


sample <- sample(c(TRUE, FALSE), nrow(data), replace=TRUE, prob=c(0.7,0.3))
train <- data[sample, ]
test <- data[!sample, ]

sample_normalized <- sample(c(TRUE, FALSE), nrow(data_normalized), replace=TRUE, prob=c(0.7,0.3))
train_normalized <- data_normalized[sample, ]
test_normalized <- data_normalized[!sample, ]

logistic_model <- glm(mvp ~ pts + ast + reb + win_pct,
                      data = train,
                      family = "binomial")
logistic_model_normalized <- glm(mvp ~ pts + ast + reb + win_pct,
                      data = train_normalized,
                      family = "binomial")

summary(logistic_model)
summary(logistic_model_normalized)

test_row <- tribble(
      ~pts, ~ast, ~reb,
      35, 7, 8
)

predictions <- predict(logistic_model,
                              current_season_df,
                              type = "response")
predictions_normalized <- predict(logistic_model_normalized,
                              current_season_df_normalized,
                              type = "response")


current_season_df <- mutate(current_season_df, is_mvp_candidate =  case_when(c(predictions) > 0.2 ~ 1,
                                                                     c(predictions) < 0.2 ~ 0),
                            mvp_odds = sprintf('%3f', c(predictions)))

current_season_df_normalized <- mutate(current_season_df_normalized, is_mvp_candidate =  case_when(c(predictions) > 0.2 ~ 1,
                                                                     c(predictions) < 0.2 ~ 0),
                            mvp_odds = sprintf('%3f', c(predictions)))

mvp_data <- filter(current_season_df_normalized, is_mvp_candidate == 1)
mvp_data <- summarise(mvp_data, mean = mean(pts+ast+reb+win_pct))
mvp_data

#sprintf('%3f', c(predictions)))
#ggplot(current_season_df_normalized, aes(x=pts + ast + reb, y=is_mvp_candidate)) + geom_point() + stat_smooth(method = glm, color="green", se=FALSE, method.args = list(family=binomial)) + geom_text(aes(label=ifelse(is_mvp_candidate==1,as.character(names),'')),hjust=0,vjust=0, size=2) 

ggplot(current_season_df_normalized, aes(x=pts + ast + reb + win_pct)) + geom_density(alpha=.2, fill="#FF6666") + geom_vline(aes(xintercept=0), linetype="dashed", label="All Players") + geom_vline(aes(xintercept=mvp_data$mean), linetype="dashed") + ggtitle("Density Curve of the Normalized Distribution of Cumulative Player Statistics")

#table <- head(arrange(current_season_df, desc(mvp_odds)), 10) %>% gt() %>% tab_header(title = "Predicted Top 10 MVP Standings, 2021-2022") %>% fmt_number(columns = c(pts, ast, reb, wins, total_games, win_pct))
#table %>% gtsave(filename = "MVP_Predictions_2022_Table.png", expand = 10)
#pct = sprintf("%3f", mvp_odds / sum(mvp_odds))
arrange(current_season_df, desc(mvp_odds))
```
